**ドキュメント構成**

1.  **外部設計書**
    1.1. システム概要
    1.2. 画面設計
    1.3. 機能一覧
    1.4. 非機能要件（再掲・補足）
2.  **内部設計書**
    2.1. システム構成図
    2.2. コンポーネント設計 (Next.js)
    2.3. API設計 (Next.js API Routes/Route Handlers)
    2.4. データ設計 (LLMへの入力・LLMからの出力)
    2.5. プロンプト設計方針
    2.6. エラー処理設計

---

**1. 外部設計書**

**1.1. システム概要**

*   **システム名:** 求人票デコーダー (MVP)
*   **目的:** 求人票のテキストを入力すると、LLMを活用してその内容を分析し、注意すべき表現や曖昧な箇所に対する「本音の可能性」や「確認すべきポイント」をユーザーに提示する。
*   **ターゲットユーザー:** 就職・転職活動中の求職者。
*   **提供形態:** Webアプリケーション (Cloudflare PagesにデプロイされたNext.jsアプリケーション)

**1.2. 画面設計**

**1.2.1. メイン画面 (1画面構成)**

*   **画面ID:** SCR-001
*   **画面名:** 求人票デコード画面
*   **概要:** ユーザーが求人票テキストを入力し、解析結果を閲覧するメインの画面。
*   **レイアウト案 (ワイヤーフレームレベル):**

    ```
    +------------------------------------------------------+
    | 求人票デコーダー (ヘッダー/タイトル)                 |
    +------------------------------------------------------+
    |                                                      |
    |  求人票のテキストを貼り付けてください:                 |
    |  +------------------------------------------------+  |
    |  | (テキストエリア: 高さ調整可能、複数行入力)       |  |
    |  |                                                |  |
    |  |                                                |  |
    |  +------------------------------------------------+  |
    |                                                      |
    |  [ デコード開始 ] (ボタン)                           |
    |                                                      |
    +------------------------------------------------------+
    | 解析結果:                                            |
    |  +------------------------------------------------+  |
    |  | (ローディング表示エリア / 結果表示エリア)        |  |
    |  |                                                |  |
    |  | 例:                                            |  |
    |  |   - 元の表現: アットホームな職場                 |  |
    |  |     - 本音の可能性:                            |  |
    |  |       - 人間関係が密な可能性...                |  |
    |  |       - チームワーク重視の裏返し...              |  |
    |  |     - 確認すべきポイント:                      |  |
    |  |       - 具体的な社風は？                       |  |
    |  |       - 業務時間外の付き合いは？                 |  |
    |  |   (繰り返し)                                   |  |
    |  |                                                |  |
    |  | (エラーメッセージ表示エリア)                     |  |
    |  +------------------------------------------------+  |
    |                                                      |
    +------------------------------------------------------+
    | フッター (コピーライト、免責事項など)                |
    +------------------------------------------------------+
    ```

*   **画面要素:**
    *   **タイトル/ヘッダー:** アプリケーション名を表示。
    *   **求人票入力エリア (テキストエリア):**
        *   複数行入力可能。
        *   プレースホルダーテキスト (例: 「ここに求人票のテキストを貼り付けてください」)。
    *   **デコード開始ボタン:** クリックすると解析処理を開始。処理中は非活性化またはローディング表示。
    *   **解析結果表示エリア:**
        *   初期状態: 空白または説明文。
        *   処理中: ローディングスピナーや「解析中です...」などのメッセージを表示。
        *   結果表示: LLMからの解析結果を整形して表示。
            *   検出された元の表現。
            *   それに対する「本音の可能性」リスト。
            *   それに対する「確認すべきポイント」リスト。
            *   複数の指摘事項がある場合は、それぞれをカード形式などで分かりやすく区切る。
        *   エラー発生時: エラーメッセージを表示 (例: 「解析に失敗しました。時間をおいて再度お試しください。」「入力テキストが短すぎます。」)。
    *   **フッター:**
        *   コピーライト表示。
        *   免責事項 (例: 「本サービスの結果はAIによるものであり、あくまで参考情報です。最終的な判断はご自身で行ってください。」)。

**1.3. 機能一覧**

| 機能ID   | 機能名                     | 概要                                                                 | 備考                               |
| :------- | :------------------------- | :------------------------------------------------------------------- | :--------------------------------- |
| FUN-001  | 求人票テキスト入力         | ユーザーがテキストエリアに求人票の文章を貼り付けて入力できる。         |                                    |
| FUN-002  | 求人票デコード実行         | 「デコード開始」ボタン押下で、入力されたテキストをLLM APIに送信し解析を依頼する。 | APIキーはサーバーサイドで管理。      |
| FUN-003  | 解析結果表示             | LLMからの解析結果（注意すべき表現、本音の可能性、確認ポイント）を画面に表示する。 | ローディング表示、エラー表示も含む。 |
| FUN-004  | 免責事項表示             | 解析結果がAIによる参考情報であることを明示する。                       | フッター等に記載。                 |

**1.4. 非機能要件（再掲・補足）**

*   **ユーザビリティ:**
    *   シンプルで直感的な操作性。
    *   レスポンシブデザイン（スマートフォン、PCで適切に表示・操作可能）。
*   **パフォーマンス:**
    *   LLM APIの応答速度に依存するが、ユーザーが待てる範囲（数秒～10秒程度）を目指す。
    *   ローディング表示で体感速度を改善。
*   **セキュリティ:**
    *   LLM APIキーはNext.jsのAPI Routes/Route Handlers内で環境変数として管理し、クライアントに漏洩しない。
    *   入力された求人票テキストは、解析目的以外には利用しないことを明記（プライバシーポリシー等）。
*   **信頼性:**
    *   LLMの出力は確率的なものであるため、結果が常に完璧ではないことをユーザーに理解させる（免責事項）。
    *   エラーハンドリングを適切に行い、予期せぬエラー発生時もユーザーに状況を伝える。

---

**2. 内部設計書**

**2.1. システム構成図**

```mermaid
graph TD
    A[ユーザーブラウザ (Next.jsフロントエンド)] -- HTTPS --> B(Cloudflare Pages);
    B -- Next.js API Route/Route Handler --> C{LLM API (例: OpenAI API)};
    C -- API Key (環境変数) --> B;
    subgraph "Cloudflare Pages"
        B
    end
    subgraph "外部LLMサービス"
        C
    end
```

*   **ユーザーブラウザ:** Next.jsで構築されたフロントエンドUIを表示・操作。
*   **Cloudflare Pages:** Next.jsアプリケーションをホスティング。
    *   **Next.js API Routes/Route Handlers:** フロントエンドからのリクエストを受け付け、バックエンドとして機能。LLM APIとの通信を仲介し、APIキーを安全に管理する。
*   **LLM API:** OpenAI API, Google Gemini APIなど。プロンプトに基づき求人票テキストを解析し、結果をJSON形式で返す。

**2.2. コンポーネント設計 (Next.js)**

Next.jsのApp Routerを想定したコンポーネント構成例です。Pages Routerでも同様の考え方で分割できます。

*   **`app/layout.tsx`:** 全体のレイアウト（ヘッダー、フッターなど）。
*   **`app/page.tsx`:** メインページ。状態管理（入力テキスト、解析結果、ローディング状態、エラー状態）と、子コンポーネントの配置。
    *   **`components/JobPostingForm.tsx`:** 求人票入力フォームとデコード開始ボタンを持つコンポーネント。
        *   Props: `onSubmit(text: string)`, `isLoading: boolean`
        *   入力テキストを親コンポーネントに渡す。
    *   **`components/DecodingResult.tsx`:** 解析結果を表示するコンポーネント。
        *   Props: `result: LLMResponse | null`, `isLoading: boolean`, `error: string | null`
        *   ローディング状態やエラー状態に応じて表示を切り替える。
        *   結果を整形して表示。
    *   **`components/Header.tsx`:** ヘッダーコンポーネント。
    *   **`components/Footer.tsx`:** フッターコンポーネント（免責事項含む）。

**状態管理 (例: `app/page.tsx` 内で `useState` を使用)**

*   `jobPostingText: string`: 入力された求人票テキスト。
*   `decodingResult: LLMResponse | null`: LLMからの解析結果 (後述のデータ設計参照)。
*   `isLoading: boolean`: 解析処理中かどうかのフラグ。
*   `error: string | null`: エラーメッセージ。

**2.3. API設計 (Next.js API Routes/Route Handlers)**

*   **エンドポイント:** `/api/decode-job-posting`
*   **HTTPメソッド:** `POST`
*   **リクエストボディ (JSON):**
    ```json
    {
      "text": "ここに求人票のテキストが入ります..."
    }
    ```
*   **レスポンス (成功時 - HTTP 200 OK) (JSON):**
    *   LLMからの解析結果 (後述のデータ設計参照)。
    ```json
    {
      "findings": [
        {
          "original_phrase": "アットホームな職場",
          "potential_realities": [
            "人間関係が非常に密で、プライベートな交流も多い可能性がある。",
            "チームワークや協調性が極めて重視され、個人での成果よりもチーム全体の調和が優先される文化かもしれない。"
          ],
          "points_to_check": [
            "具体的な社風やコミュニケーションの頻度について質問する。",
            "業務時間外の付き合いやイベント参加の任意性について確認する。"
          ]
        }
        // ... 他の発見
      ]
    }
    ```
*   **レスポンス (エラー時):**
    *   HTTP 400 Bad Request (例: 入力テキストが空、短すぎる場合):
        ```json
        { "error": "入力テキストが短すぎます。" }
        ```
    *   HTTP 500 Internal Server Error (例: LLM APIエラー、予期せぬサーバーエラー):
        ```json
        { "error": "サーバーでエラーが発生しました。時間をおいて再度お試しください。" }
        ```
*   **認証:** MVPではなし。将来的にレートリミットなどを検討。
*   **処理フロー:**
    1.  リクエストボディから`text`を取得。
    2.  入力バリデーション（空でないか、最低文字数など）。
    3.  環境変数からLLM APIキーを取得。
    4.  プロンプトを生成（求人票テキストを埋め込む）。
    5.  LLM APIにリクエストを送信。
    6.  LLM APIからのレスポンス（JSON想定）をパース。
    7.  成功レスポンスまたはエラーレスポンスをクライアントに返す。

**2.4. データ設計 (LLMへの入力・LLMからの出力)**

*   **LLMへの入力 (プロンプトの一部として送信する求人票テキスト):**
    *   `string`型: ユーザーが入力した求人票のプレーンテキスト。
*   **LLMからの期待される出力 (JSON形式):**
    *   型定義 (TypeScript):
        ```typescript
        interface Finding {
          original_phrase: string; // LLMが注目した元の表現
          potential_realities: string[]; // 本音の可能性 (複数)
          points_to_check: string[];   // 確認すべきポイント (複数)
        }

        interface LLMResponse {
          findings: Finding[]; // 複数の指摘事項
        }
        ```
    *   この構造をプロンプトでLLMに指示する。

**2.5. プロンプト設計方針**

*   **役割設定:** 「あなたは経験豊富なキャリアアドバイザーです。」など、LLMに適切な役割を与える。
*   **タスク指示:** 具体的に何をしてほしいかを明確に指示する。
    *   「以下の求人票テキストを分析してください。」
    *   「特に注意すべき表現や曖昧な箇所を特定してください。」
    *   「それぞれの箇所について、『本音の可能性』と『面接で確認すべきポイント』を提示してください。」
*   **出力形式指定:** JSON形式での出力を厳密に指示し、期待するJSON構造の例を示す (Few-shot prompting)。
    *   上記 `LLMResponse` のような構造例をプロンプトに含める。
*   **制約・注意点:**
    *   「客観的かつ中立的な視点で。」
    *   「断定的な表現は避けてください。」
    *   「複数の可能性を提示してください。」
    *   「もし該当する表現が見つからない場合は、`findings` 配列を空にしてください。」
*   **求人票テキストの埋め込み:** プロンプトテンプレート内で、ユーザー入力テキストを適切に挿入する箇所を設ける。
*   **継続的な改善:** 初期プロンプトでリリース後、実際の出力結果やユーザーフィードバックを元に、プロンプトを繰り返し調整・改善する。

**2.6. エラー処理設計**

*   **フロントエンド (クライアントサイド):**
    *   APIリクエスト前:
        *   入力テキストが空、または極端に短い場合は、APIを呼び出さずにエラーメッセージを表示。
    *   APIリクエスト後:
        *   HTTPステータスコードやレスポンスボディを見てエラーを判定。
        *   `try...catch`構文でネットワークエラーなどを捕捉。
        *   ユーザーフレンドリーなエラーメッセージを表示エリアに表示 (例: 「解析に失敗しました。時間をおいて再度お試しください。」)。
        *   コンソールには詳細なエラー情報をログ出力（デバッグ用）。
*   **Next.js API Route/Route Handler (サーバーサイド):**
    *   入力バリデーションエラー (400 Bad Request)。
    *   LLM APIキー未設定エラー (500 Internal Server Error)。
    *   LLM API通信エラー (タイムアウト、API側のエラーなど) (500 Internal Server Error または LLM APIが返すステータスに応じたエラー)。
        *   LLM APIからのエラーレスポンスを適切にハンドリングし、クライアントには汎用的なエラーメッセージを返すか、場合によっては具体的な情報を加工して返す。
    *   予期せぬ内部エラー (500 Internal Server Error)。
    *   `try...catch`構文でエラーを捕捉し、適切なHTTPステータスコードとエラーメッセージを返す。
    *   サーバーログには詳細なエラー情報を記録。
